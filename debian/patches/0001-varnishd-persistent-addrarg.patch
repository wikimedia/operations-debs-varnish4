From: Emanuele Rocca <ema@wikimedia.org>
Date: Sat, 16 Jan 2016 14:23:07 +0100
Subject: varnishd-persistent-addrarg

---
 bin/varnishd/storage/mgt_storage_persistent.c | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/bin/varnishd/storage/mgt_storage_persistent.c b/bin/varnishd/storage/mgt_storage_persistent.c
index 76d6436..31b17d3 100644
--- a/bin/varnishd/storage/mgt_storage_persistent.c
+++ b/bin/varnishd/storage/mgt_storage_persistent.c
@@ -160,8 +160,8 @@ smp_mgt_init(struct stevedore *parent, int ac, char * const *av)
 	VTAILQ_INIT(&sc->segments);
 
 	/* Argument processing */
-	if (ac != 2)
-		ARGV_ERR("(-spersistent) wrong number of arguments\n");
+	if (ac < 2 || ac >3)
+		ARGV_ERR("(-spersistent) wrong number of arguments; should be file,address]\n");
 
 	i = STV_GetFile(av[0], &sc->fd, &sc->filename, "-spersistent");
 	if (i == 2)
@@ -179,6 +179,12 @@ smp_mgt_init(struct stevedore *parent, int ac, char * const *av)
 	assert(i == sizeof sgn);
 	if (!strcmp(sgn.ident, "SILO"))
 		target = (void*)(uintptr_t)sgn.mapped;
+	else if(ac == 3) { // provided explicit addr arg for new storage
+		errno = 0;
+		target = (void*)(uintptr_t)strtoull(av[2], NULL, 0);
+		if(errno)
+			ARGV_ERR("(-spersistent) address argument '%s' invalid: %s", av[2], strerror(errno));
+	}
 	else
 		target = NULL;
 
